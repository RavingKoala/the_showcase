@model IEnumerable<LobbyListItem>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

<table class="table">
    <tbody>
    @foreach (var lobby in Model) {
        <tr>
            <td>@lobby.Name</td>
            <td>
                <form class="inlineForm" asp-action="Join" method="post">
                    <input type="hidden" name="id" value="@lobby.Id" />
                    <input class="btn btn-primary" type="submit" value="Join" />
                </form>
        @if (User.IsInRole("Admin")) {
                        <button class="btn btn-danger deleteBtn" data-lobby-name="@lobby.Name" data-lobby-id="@lobby.Id" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">Delete</button>
        }
            </td>
        </tr>
    }
    </tbody>
</table>

<p>
    <a class="btn btn-primary" asp-action="Create">Create New</a>
</p>

@if (User.IsInRole("Admin")) {
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel"> Delete Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Loby name:</p>
                    <p class="lobbyName"></p>
                </div>
                <div class="modal-footer">
                    <form asp-action="Delete" method="post" id="deleteForm">
                        <input type="hidden" id="lobbyId" name="id" />
                        <input type="submit" class="btn btn-primary" value="Delete" />
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var deleteConfirmationModal = document.getElementById('deleteConfirmationModal')
        deleteConfirmationModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget
            var lobbyId = button.getAttribute('data-lobby-id')
            var lobbyName = button.getAttribute('data-lobby-name')
            console.log(button, lobbyId, lobbyName)
            deleteConfirmationModal.querySelector('.lobbyName').textContent = lobbyName
            deleteConfirmationModal.querySelector('#lobbyId').value = lobbyId
        })
    </script>
    <script>
        function handleEvent(event) {
            console.log('Received message:', event.data);
            // You can handle the event data here, for example update your UI
        }

        function Connect() {
            const eventSource = new EventSource('http://localhost/Lobbies/SSE/Connect');

            eventSource.onmessage = (event) => {
                console.log(event)
            }
                ;
            eventSource.onopen = (event) => {
                console.log('Connected to SSE server')
            }
            eventSource.onerror = (error) => {
                console.error('Error occurred:', error)
                // TODO: reconnect?
            })
        }

        function Disconnect() {
            if (eventSource) {
                eventSource.close();
                console.log('Disconnected from SSE server');
            }
        }

        // Connect to SSE when the page loads
        window.onload = function () {
            Connect();
        };

        window.onbeforeunload = function () {
            disconnectFromSSE();
        };
    </script>
}
